[
  {
    "script": {
      "description": "Evaluate Kafka broker health",
      "lang": "painless",
      "source": "// Initialize health structure if it doesn't exist\nif (ctx.health == null) {\n  ctx.health = new HashMap();\n  ctx.health.issues = new ArrayList();\n}\n\n// Constants for severity levels\ndef HEALTHY = 0;\ndef WARNING = 1;\ndef CRITICAL = 2;\n\n// Initialize Kafka health structure\nif (ctx.health.kafka == null) {\n  ctx.health.kafka = new HashMap();\n  ctx.health.kafka.status = HEALTHY;\n  ctx.health.kafka.metrics = new HashMap();\n}\n\n// Check if we have Kafka metrics to evaluate\nif (ctx.containsKey('kafka')) {\n  // Evaluate request queue\n  if (ctx.containsKey('kafka.broker.request.queue')) {\n    def metric = ctx['kafka.broker.request.queue'];\n    def metricName = 'broker.request.queue';\n    def status = HEALTHY;\n    def message = null;\n\n    // Get thresholds from enrichment\n    def warning = ctx.threshold?.kafka?.broker?.request?.queue?.warning;\n    def critical = ctx.threshold?.kafka?.broker?.request?.queue?.critical;\n\n    if (critical != null && metric >= critical) {\n      status = CRITICAL;\n      message = 'Kafka broker request queue is critically high: ' + metric + ' (threshold: ' + critical + ')';\n    } else if (warning != null && metric >= warning) {\n      status = WARNING;\n      message = 'Kafka broker request queue is high: ' + metric + ' (threshold: ' + warning + ')';\n    }\n\n    // Store metric evaluation\n    ctx.health.kafka.metrics[metricName] = new HashMap();\n    ctx.health.kafka.metrics[metricName].value = metric;\n    ctx.health.kafka.metrics[metricName].status = status;\n    ctx.health.kafka.metrics[metricName].warning_threshold = warning;\n    ctx.health.kafka.metrics[metricName].critical_threshold = critical;\n\n    // Update overall Kafka status\n    if (status > ctx.health.kafka.status) {\n      ctx.health.kafka.status = status;\n    }\n\n    // Add issue if not healthy\n    if (status > HEALTHY && message != null) {\n      def issue = new HashMap();\n      issue.component = 'kafka';\n      issue.metric = metricName;\n      issue.severity = status == CRITICAL ? 'critical' : 'warning';\n      issue.message = message;\n      ctx.health.issues.add(issue);\n    }\n  }\n\n  // Evaluate request time\n  if (ctx.containsKey('kafka.broker.request.time.avg.ms')) {\n    def metric = ctx['kafka.broker.request.time.avg.ms'];\n    def metricName = 'broker.request.time.avg.ms';\n    def status = HEALTHY;\n    def message = null;\n\n    // Get thresholds from enrichment\n    def warning = ctx.threshold?.kafka?.broker?.request?.time?.avg?.ms?.warning;\n    def critical = ctx.threshold?.kafka?.broker?.request?.time?.avg?.ms?.critical;\n\n    if (critical != null && metric >= critical) {\n      status = CRITICAL;\n      message = 'Kafka broker request time is critically high: ' + metric + ' ms (threshold: ' + critical + ' ms)';\n    } else if (warning != null && metric >= warning) {\n      status = WARNING;\n      message = 'Kafka broker request time is high: ' + metric + ' ms (threshold: ' + warning + ' ms)';\n    }\n\n    // Store metric evaluation\n    ctx.health.kafka.metrics[metricName] = new HashMap();\n    ctx.health.kafka.metrics[metricName].value = metric;\n    ctx.health.kafka.metrics[metricName].status = status;\n    ctx.health.kafka.metrics[metricName].warning_threshold = warning;\n    ctx.health.kafka.metrics[metricName].critical_threshold = critical;\n\n    // Update overall Kafka status\n    if (status > ctx.health.kafka.status) {\n      ctx.health.kafka.status = status;\n    }\n\n    // Add issue if not healthy\n    if (status > HEALTHY && message != null) {\n      def issue = new HashMap();\n      issue.component = 'kafka';\n      issue.metric = metricName;\n      issue.severity = status == CRITICAL ? 'critical' : 'warning';\n      issue.message = message;\n      ctx.health.issues.add(issue);\n    }\n  }\n\n  // Add similar evaluations for other Kafka metrics\n  // ...\n}"
    }
  }
]
