[
  {
    "script": {
      "description": "Evaluate SLO health",
      "lang": "painless",
      "source": "// Initialize health structure if it doesn't exist\nif (ctx.health == null) {\n  ctx.health = new HashMap();\n  ctx.health.issues = new ArrayList();\n}\n\n// Initialize SLO health structure\nif (ctx.health.slo == null) {\n  ctx.health.slo = new HashMap();\n  ctx.health.slo.metrics = new ArrayList();\n}\n\n// Check if we have SLO relevant metrics\nif (ctx.containsKey('metadata.slo_relevant') && ctx['metadata.slo_relevant'] == true) {\n\n  // Get service details\n  def serviceName = ctx.containsKey('service.name') ? ctx['service.name'] : 'unknown';\n  def serviceType = ctx.containsKey('service.type') ? ctx['service.type'] : 'unknown';\n  def environment = ctx.containsKey('service.environment') ? ctx['service.environment'] : 'unknown';\n\n  // Determine SLO status based on health checks\n  def sloStatus = 'met';  // Default to met\n\n  // Check if we have health issues\n  if (ctx.health.issues != null && !ctx.health.issues.isEmpty()) {\n    // Count critical and warning issues\n    def criticalCount = 0;\n    def warningCount = 0;\n\n    for (def issue : ctx.health.issues) {\n      if (issue.severity == 'critical') {\n        criticalCount++;\n      } else if (issue.severity == 'warning') {\n        warningCount++;\n      }\n    }\n\n    // Determine SLO status based on issue counts\n    if (criticalCount > 0) {\n      sloStatus = 'breached';\n    } else if (warningCount > 0) {\n      sloStatus = 'at_risk';\n    }\n  }\n\n  // Create SLO metric\n  def sloMetric = new HashMap();\n  sloMetric.service = serviceName;\n  sloMetric.type = serviceType;\n  sloMetric.environment = environment;\n  sloMetric.status = sloStatus;\n  sloMetric.timestamp = ctx['@timestamp'];\n\n  // Add to SLO metrics list\n  ctx.health.slo.metrics.add(sloMetric);\n\n  // Update overall SLO status\n  if (ctx.health.slo.status == null ||\n      (sloStatus == 'breached' && ctx.health.slo.status != 'breached') ||\n      (sloStatus == 'at_risk' && ctx.health.slo.status == 'met')) {\n    ctx.health.slo.status = sloStatus;\n  }\n}"
    }
  }
]
