[
  {
    "script": {
      "description": "Evaluate system metrics health",
      "lang": "painless",
      "source": "// Initialize health structure if it doesn't exist\nif (ctx.health == null) {\n  ctx.health = new HashMap();\n  ctx.health.issues = new ArrayList();\n}\n\n// Constants for severity levels\ndef HEALTHY = 0;\ndef WARNING = 1;\ndef CRITICAL = 2;\n\n// Initialize system health structure\nif (ctx.health.system == null) {\n  ctx.health.system = new HashMap();\n  ctx.health.system.status = HEALTHY;\n  ctx.health.system.metrics = new HashMap();\n}\n\n// Check if we have system metrics to evaluate\nif (ctx.containsKey('system')) {\n  // Evaluate CPU usage\n  if (ctx.containsKey('system.cpu.usage.pct')) {\n    def metric = ctx['system.cpu.usage.pct'];\n    def metricName = 'cpu.usage.pct';\n    def status = HEALTHY;\n    def message = null;\n\n    // Get thresholds from enrichment\n    def warning = ctx.threshold?.system?.cpu?.usage?.pct?.warning;\n    def critical = ctx.threshold?.system?.cpu?.usage?.pct?.critical;\n\n    if (critical != null && metric >= critical) {\n      status = CRITICAL;\n      message = 'System CPU usage is critically high: ' + (metric * 100).round(2) + '% (threshold: ' + (critical * 100).round(2) + '%)';\n    } else if (warning != null && metric >= warning) {\n      status = WARNING;\n      message = 'System CPU usage is high: ' + (metric * 100).round(2) + '% (threshold: ' + (warning * 100).round(2) + '%)';\n    }\n\n    // Store metric evaluation\n    ctx.health.system.metrics[metricName] = new HashMap();\n    ctx.health.system.metrics[metricName].value = metric;\n    ctx.health.system.metrics[metricName].status = status;\n    ctx.health.system.metrics[metricName].warning_threshold = warning;\n    ctx.health.system.metrics[metricName].critical_threshold = critical;\n\n    // Update overall system status\n    if (status > ctx.health.system.status) {\n      ctx.health.system.status = status;\n    }\n\n    // Add issue if not healthy\n    if (status > HEALTHY && message != null) {\n      def issue = new HashMap();\n      issue.component = 'system';\n      issue.metric = metricName;\n      issue.severity = status == CRITICAL ? 'critical' : 'warning';\n      issue.message = message;\n      ctx.health.issues.add(issue);\n    }\n  }\n\n  // Evaluate memory usage\n  if (ctx.containsKey('system.memory.used.pct')) {\n    def metric = ctx['system.memory.used.pct'];\n    def metricName = 'memory.used.pct';\n    def status = HEALTHY;\n    def message = null;\n\n    // Get thresholds from enrichment\n    def warning = ctx.threshold?.system?.memory?.used?.pct?.warning;\n    def critical = ctx.threshold?.system?.memory?.used?.pct?.critical;\n\n    if (critical != null && metric >= critical) {\n      status = CRITICAL;\n      message = 'System memory usage is critically high: ' + (metric * 100).round(2) + '% (threshold: ' + (critical * 100).round(2) + '%)';\n    } else if (warning != null && metric >= warning) {\n      status = WARNING;\n      message = 'System memory usage is high: ' + (metric * 100).round(2) + '% (threshold: ' + (warning * 100).round(2) + '%)';\n    }\n\n    // Store metric evaluation\n    ctx.health.system.metrics[metricName] = new HashMap();\n    ctx.health.system.metrics[metricName].value = metric;\n    ctx.health.system.metrics[metricName].status = status;\n    ctx.health.system.metrics[metricName].warning_threshold = warning;\n    ctx.health.system.metrics[metricName].critical_threshold = critical;\n\n    // Update overall system status\n    if (status > ctx.health.system.status) {\n      ctx.health.system.status = status;\n    }\n\n    // Add issue if not healthy\n    if (status > HEALTHY && message != null) {\n      def issue = new HashMap();\n      issue.component = 'system';\n      issue.metric = metricName;\n      issue.severity = status == CRITICAL ? 'critical' : 'warning';\n      issue.message = message;\n      ctx.health.issues.add(issue);\n    }\n  }\n\n  // Add similar evaluations for other system metrics\n  // ...\n}"
    }
  }
]
